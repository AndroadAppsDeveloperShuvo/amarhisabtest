<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ñ‡¶æ‡¶Æ‡¶æ‡¶∞ - ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶æ‡¶∞</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root { --color-primary: #00796B; }
        body { font-family: 'Noto Sans Bengali', sans-serif; -webkit-font-smoothing: antialiased; }
        
        /* Transition */
        body, .page, .bg-white, .bg-gray-50, .text-gray-900, .text-gray-500 { transition: background-color 0.3s, color 0.3s, border-color 0.3s; }

        .page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; display: none; }
        .page-visible { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .scrolling-text { overflow: hidden; white-space: nowrap; background: #E0F2F1; padding: 8px 12px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid var(--color-primary); }
        .dark .scrolling-text { background: #004D40; border-left-color: #4DB6AC; color: #E0F2F1; }
        .scrolling-text span { display: inline-block; padding-left: 100%; animation: scroll-left 15s linear infinite; color: var(--color-primary); font-weight: 600; }
        .dark .scrolling-text span { color: #80CBC4; }
        @keyframes scroll-left { 0% { transform: translateX(0%); } 100% { transform: translateX(-100%); } }
        
        #pdf-overlay { display: none; }
        .pdf-table th, .pdf-table td { border: 1px solid #ccc; padding: 8px; font-size: 13px; text-align: left; color: black; }
        .pdf-table th { background-color: #eee; font-weight: bold; }
        
        details > summary { list-style: none; cursor: pointer; transition: 0.2s; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary { background-color: #E0F2F1; color: #00796B; }
        .dark details[open] > summary { background-color: #004D40; color: #80CBC4; }
    </style>
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: { extend: { colors: { primary: '#00796B' } } } 
        }
        // Theme Check
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100">

    <div id="auth-page" class="fixed inset-0 z-50 bg-gray-50 dark:bg-gray-900 flex flex-col justify-center items-center p-6">
        <div class="w-full max-w-sm bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl border border-gray-100 dark:border-gray-700">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-teal-50 dark:bg-teal-900/30 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl shadow-sm">üêî</div>
                <h1 class="text-3xl font-bold text-teal-700 dark:text-teal-400">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</h1>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶™‡ßã‡¶≤‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶ñ‡¶æ‡¶Æ‡¶æ‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</p>
            </div>

            <button onclick="handleGoogleLogin()" class="w-full p-3 mb-6 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-xl flex items-center justify-center gap-3 hover:bg-gray-50 dark:hover:bg-gray-600 transition shadow-sm">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5" alt="Google">
                <span class="font-bold text-gray-700 dark:text-white">Google ‡¶¶‡¶ø‡ßü‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</span>
            </button>

            <div class="flex items-center gap-2 mb-6">
                <div class="h-[1px] bg-gray-200 dark:bg-gray-600 flex-grow"></div>
                <span class="text-xs text-gray-400 font-medium">‡¶Ö‡¶•‡¶¨‡¶æ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¶‡¶ø‡ßü‡ßá</span>
                <div class="h-[1px] bg-gray-200 dark:bg-gray-600 flex-grow"></div>
            </div>

            <div id="login-form-container">
                <input type="email" id="login-email" placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤" class="w-full p-4 mb-4 rounded-xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-teal-500 dark:text-white">
                <input type="password" id="login-pass" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°" class="w-full p-4 mb-2 rounded-xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-teal-500 dark:text-white">
                
                <div class="text-right mb-6">
                    <button onclick="handleForgotPassword()" class="text-xs text-teal-600 dark:text-teal-400 font-bold hover:underline">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡¶®?</button>
                </div>

                <button onclick="handleLogin()" class="w-full p-4 bg-teal-700 hover:bg-teal-800 text-white font-bold rounded-xl shadow-lg transition transform active:scale-95">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <p class="mt-6 text-center text-sm text-gray-500 dark:text-gray-400">‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á? <button onclick="toggleAuthMode()" class="text-teal-700 dark:text-teal-400 font-bold hover:underline">‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶®</button></p>
            </div>

            <div id="register-form-container" class="hidden">
                <input type="email" id="reg-email" placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤" class="w-full p-4 mb-4 rounded-xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white">
                <input type="password" id="reg-pass" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°" class="w-full p-4 mb-6 rounded-xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white">
                <button onclick="handleRegister()" class="w-full p-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg transition transform active:scale-95">‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <p class="mt-6 text-center text-sm text-gray-500 dark:text-gray-400">‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá? <button onclick="toggleAuthMode()" class="text-teal-700 dark:text-teal-400 font-bold hover:underline">‡¶≤‡¶ó‡¶á‡¶®</button></p>
            </div>
            <p id="auth-error" class="text-red-500 text-sm text-center mt-4 font-medium"></p>
        </div>
    </div>

    <main id="main-app" class="relative max-w-md mx-auto h-screen overflow-hidden hidden shadow-2xl bg-gray-50 dark:bg-gray-900">
        
        <div id="dashboard" class="page tab-page page-visible bg-gray-50 dark:bg-gray-900">
            <header class="sticky top-0 z-10 p-5 bg-white/90 dark:bg-gray-800/90 backdrop-blur-md border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-teal-700 dark:text-teal-400">‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</h1>
                    <p class="text-xs text-gray-500 dark:text-gray-400" id="current-date">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</p>
                </div>
                <div class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-teal-700 dark:text-teal-400">üîî</div>
            </header>
            <div class="p-5 space-y-6 pb-28">
                <div id="dashboard-summary" class="transform transition hover:scale-[1.02]"></div>
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-gray-800 dark:text-gray-200">‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶ö‡¶æ‡¶≤‡¶æ‡¶®</h2>
                        <button onclick="navigateToTab('shipments-page')" class="text-xs text-teal-600 dark:text-teal-400 font-bold">‡¶∏‡¶¨ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
                    </div>
                    <div id="ongoing-shipments-list" class="space-y-3"></div>
                </div>
            </div>
        </div>
        
        <div id="shipments-page" class="page tab-page bg-gray-50 dark:bg-gray-900">
            <header class="sticky top-0 z-10 p-5 bg-white/90 dark:bg-gray-800/90 backdrop-blur-md border-b border-gray-100 dark:border-gray-700"><h1 class="text-xl font-bold text-center dark:text-white">‡¶∏‡¶ï‡¶≤ ‡¶ö‡¶æ‡¶≤‡¶æ‡¶®</h1></header>
            <div class="p-5 space-y-3 pb-28" id="all-shipments-list"></div>
        </div>
        
        <div id="medicines-page" class="page tab-page bg-gray-50 dark:bg-gray-900">
            <header class="sticky top-0 z-40 bg-white/80 dark:bg-gray-800/80 backdrop-blur-md border-b border-gray-200 dark:border-gray-700 p-4 flex items-center justify-between">
                <div class="relative">
                    <button onclick="toggleMenu('dropdownMenu')" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition"><span class="material-symbols-outlined dark:text-white">menu</span></button>
                    <div id="dropdownMenu" class="hidden absolute left-0 mt-2 w-48 bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-xl shadow-2xl z-50 overflow-hidden">
                        <button onclick="document.getElementById('profileCard').classList.remove('hidden'); this.parentElement.classList.add('hidden');" class="w-full text-left px-4 py-3 flex items-center gap-3 hover:bg-gray-50 dark:hover:bg-gray-700 dark:text-gray-200 transition border-b dark:border-gray-700"><span class="material-symbols-outlined text-primary">person</span> ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</button>
                        <button onclick="location.reload()" class="w-full text-left px-4 py-3 flex items-center gap-3 hover:bg-gray-50 dark:hover:bg-gray-700 dark:text-gray-200 transition"><span class="material-symbols-outlined text-blue-500">refresh</span> ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂</button>
                    </div>
                </div>
                <h1 class="text-lg font-bold text-teal-700 dark:text-teal-400">‡¶ì‡¶∑‡ßÅ‡¶ß‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h1>
                <div class="w-10"></div> 
            </header>

            <div id="profileCard" class="fixed inset-0 flex items-center justify-center bg-black/60 hidden z-[60] backdrop-blur-sm" onclick="this.classList.add('hidden')">
                <div class="bg-white dark:bg-gray-800 rounded-3xl p-8 w-80 relative shadow-2xl transform transition-all" onclick="event.stopPropagation()">
                    <button onclick="document.getElementById('profileCard').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition"><span class="material-symbols-outlined">close</span></button>
                    <div class="flex flex-col items-center text-center">
                        <img src="https://i.ibb.co/NdSxJghH/1759806262489.png" alt="Profile" class="rounded-full w-24 h-24 mb-4 border-4 border-teal-100 p-1">
                        <h2 class="text-xl font-bold mb-1 dark:text-white">DEVELOPER SHUVO</h2>
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-2xl mt-2"><p class="text-sm text-gray-600 dark:text-gray-300 leading-relaxed">‡¶è‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡ßá ‡¶∂‡ßÅ‡¶≠ ‡¶™‡ßç‡¶∞‡¶æ‡¶Æ‡¶æ‡¶®‡¶ø‡¶ï!</p></div>
                    </div>
                </div>
            </div>

            <div class="max-w-xl mx-auto p-5 pb-28">
                <div class="scrolling-text"><span id="scrollText">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span></div>
                <div id="medicineListContainer" class="space-y-6 medicine-container"></div>
            </div>

            <div class="fixed bottom-24 right-6 z-40">
                <button onclick="openVideoModal()" class="w-16 h-16 rounded-2xl bg-red-600 text-white shadow-lg flex items-center justify-center animate-bounce"><span class="material-symbols-outlined text-4xl">play_circle</span></button>
            </div>
        </div>

        <div id="settings-page" class="page tab-page bg-gray-50 dark:bg-gray-900">
            <header class="sticky top-0 z-10 p-5 bg-white/90 dark:bg-gray-800/90 backdrop-blur-md border-b border-gray-100 dark:border-gray-700"><h1 class="text-xl font-bold text-center dark:text-white">‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h1></header>
            <div class="p-5 space-y-6 pb-28">
                
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
                    <h2 class="px-5 py-3 text-xs font-bold text-gray-400 uppercase tracking-wider bg-gray-50 dark:bg-gray-700/50">‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£</h2>
                    <div class="flex justify-between items-center p-4 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                        <span class="flex items-center gap-3 font-medium dark:text-gray-200"><span class="material-symbols-outlined text-gray-500">dark_mode</span> ‡¶°‡¶æ‡¶∞‡ßç‡¶ï ‡¶Æ‡ßã‡¶°</span>
                        <button onclick="toggleTheme()" class="w-12 h-6 rounded-full bg-gray-300 dark:bg-teal-600 relative transition-colors focus:outline-none">
                            <div id="theme-knob" class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-all dark:left-7 shadow-sm"></div>
                        </button>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
                    <h2 class="px-5 py-3 text-xs font-bold text-gray-400 uppercase tracking-wider bg-gray-50 dark:bg-gray-700/50">‡¶ü‡ßÅ‡¶≤‡¶∏</h2>
                    <button onclick="navigate('due-list-page')" class="w-full flex items-center justify-between p-4 hover:bg-gray-50 dark:hover:bg-gray-700 transition border-b border-gray-100 dark:border-gray-700"><span class="flex items-center gap-3 font-medium dark:text-gray-200"><span class="material-symbols-outlined text-orange-500">account_balance_wallet</span> ‡¶¨‡¶æ‡¶ï‡¶ø‡¶∞ ‡¶ñ‡¶æ‡¶§‡¶æ</span> <span class="material-symbols-outlined text-gray-400">chevron_right</span></button>
                    <button onclick="navigate('fcr-calculator-page')" class="w-full flex items-center justify-between p-4 hover:bg-gray-50 dark:hover:bg-gray-700 transition"><span class="flex items-center gap-3 font-medium dark:text-gray-200"><span class="material-symbols-outlined text-purple-500">calculate</span> FCR ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞</span> <span class="material-symbols-outlined text-gray-400">chevron_right</span></button>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
                    <h2 class="px-5 py-3 text-xs font-bold text-gray-400 uppercase tracking-wider bg-gray-50 dark:bg-gray-700/50">‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü</h2>
                    <button onclick="logoutUser()" class="w-full flex items-center justify-center gap-2 p-4 text-red-500 font-bold hover:bg-red-50 dark:hover:bg-red-900/20 transition"><span class="material-symbols-outlined">logout</span> ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
                <div class="text-center"><p class="text-xs text-gray-300 mt-1 font-mono">Dev SHUVO</p></div>
            </div>
        </div>

        <div id="shipment-details-page" class="page bg-gray-50 dark:bg-gray-900">
            <header class="sticky top-0 z-10 p-4 bg-white/90 dark:bg-gray-800/90 backdrop-blur-md border-b border-gray-100 dark:border-gray-700 flex justify-between items-center shadow-sm">
                <div class="flex items-center"><button onclick="goBack()" class="mr-2 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><span class="material-symbols-outlined dark:text-white">arrow_back</span></button><h1 id="details-shipment-name" class="text-lg font-bold truncate w-24 dark:text-white"></h1></div>
                <div class="flex gap-1">
                    <button onclick="openCategoryReport()" class="p-2 rounded-full text-purple-600 bg-purple-50 hover:bg-purple-100 dark:bg-purple-900/30 dark:text-purple-300"><span class="material-symbols-outlined">pie_chart</span></button>
                    <button onclick="sharePDF()" class="p-2 rounded-full text-teal-700 bg-teal-50 hover:bg-teal-100 dark:bg-teal-900/30 dark:text-teal-300"><span class="material-symbols-outlined">share</span></button>
                    <button onclick="deleteCurrentShipment()" class="p-2 rounded-full text-red-500 bg-red-50 hover:bg-red-100 dark:bg-red-900/30 dark:text-red-300"><span class="material-symbols-outlined">delete</span></button>
                </div>
            </header>
            <div class="p-5 space-y-5 pb-28">
                <div id="details-summary-cards" class="grid grid-cols-2 gap-4"></div>
                <div class="bg-gray-200 dark:bg-gray-700 p-1 rounded-xl flex shadow-inner"><button id="expense-tab-button" onclick="switchTab('expense')" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all shadow-sm bg-white dark:bg-gray-600 text-gray-800 dark:text-white">‡¶¨‡ßç‡¶Ø‡ßü</button><button id="income-tab-button" onclick="switchTab('income')" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all text-gray-500 dark:text-gray-400">‡¶Ü‡ßü</button></div>
                <div id="expense-list-container" class="space-y-3"></div><div id="income-list-container" class="hidden space-y-3"></div>
            </div>
            <div class="fixed bottom-24 right-6 z-20"><button onclick="prepareEntryForm()" class="w-14 h-14 rounded-full bg-teal-700 text-white shadow-xl flex items-center justify-center transform transition hover:scale-110 active:scale-95"><span class="material-symbols-outlined text-3xl">add</span></button></div>
        </div>

        <div id="category-modal" class="hidden fixed inset-0 z-[60] flex items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm">
            <div class="bg-white dark:bg-gray-800 w-full sm:w-96 rounded-t-3xl sm:rounded-3xl p-6 relative animate-[slideUp_0.3s_ease-out]">
                <button onclick="document.getElementById('category-modal').classList.add('hidden')" class="absolute top-4 right-4 p-2 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-red-100 hover:text-red-500 transition"><span class="material-symbols-outlined dark:text-gray-300">close</span></button>
                <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-1">‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶ñ‡¶æ‡¶§‡¶∏‡¶Æ‡ßÇ‡¶π</h2>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">‡¶ï‡ßã‡¶® ‡¶ñ‡¶æ‡¶§‡ßá ‡¶ï‡¶§ ‡¶ñ‡¶∞‡¶ö ‡¶π‡ßü‡ßá‡¶õ‡ßá</p>
                <div id="category-report-content" class="space-y-3 max-h-[60vh] overflow-y-auto"></div>
            </div>
        </div>

        <div id="add-shipment-page" class="page bg-white dark:bg-gray-900"><header class="p-4 border-b dark:border-gray-800 flex items-center"><button onclick="goBack()" class="mr-4"><span class="material-symbols-outlined dark:text-white">arrow_back</span></button><h1 class="text-xl font-bold dark:text-white">‡¶®‡¶§‡ßÅ‡¶® ‡¶ö‡¶æ‡¶≤‡¶æ‡¶®</h1></header><div class="p-6"><form onsubmit="saveShipment(event)" class="space-y-5"><input id="shipment-name" required placeholder="‡¶ö‡¶æ‡¶≤‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="w-full p-4 rounded-xl border bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white"><input id="shipment-chicken-count" type="number" required placeholder="‡¶Æ‡ßÅ‡¶∞‡¶ó‡¶ø‡¶∞ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ" class="w-full p-4 rounded-xl border bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white"><input id="shipment-start-date" type="date" required class="w-full p-4 rounded-xl border bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white"><button type="submit" class="w-full p-4 bg-teal-700 text-white font-bold rounded-xl shadow-lg">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button></form></div></div>
        <div id="add-entry-page" class="page bg-white dark:bg-gray-900"><header class="p-4 border-b dark:border-gray-800 flex items-center"><button onclick="goBack()" class="mr-4"><span class="material-symbols-outlined dark:text-white">arrow_back</span></button><h1 id="entry-form-title" class="text-xl font-bold dark:text-white"></h1></header><div class="p-6"><form onsubmit="saveEntry(event)" class="space-y-5"><div id="expense-fields"><select id="expense-type" class="w-full p-4 rounded-xl border bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white"><option>‡¶Æ‡ßÅ‡¶∞‡¶ó‡¶ø‡¶∞ ‡¶¨‡¶æ‡¶ö‡ßç‡¶ö‡¶æ ‡¶ï‡ßá‡¶®‡¶æ</option><option>‡¶ñ‡¶æ‡¶¨‡¶æ‡¶∞ ‡¶ñ‡¶∞‡¶ö</option><option>‡¶î‡¶∑‡¶ß ‡¶ì ‡¶≠‡¶ø‡¶ü‡¶æ‡¶Æ‡¶ø‡¶®</option><option>‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶ø‡¶ï</option><option>‡¶ó‡ßÅ‡ßú‡¶æ</option><option>‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</option></select></div><div id="income-fields" class="hidden"><input id="income-description" placeholder="‡¶¨‡¶ø‡¶¨‡¶∞‡¶£" class="w-full p-4 rounded-xl border bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white"></div><input id="entry-amount" type="number" required placeholder="‡¶ü‡¶æ‡¶ï‡¶æ" class="w-full p-4 rounded-xl border bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white"><input id="entry-date" type="date" required class="w-full p-4 rounded-xl border bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white"><textarea id="entry-note" placeholder="‡¶®‡ßã‡¶ü (‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤)" class="w-full p-4 rounded-xl border bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white"></textarea><button type="submit" class="w-full p-4 bg-teal-700 text-white font-bold rounded-xl shadow-lg">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button></form></div></div>
        <div id="fcr-calculator-page" class="page bg-white dark:bg-gray-900"><header class="p-4 border-b dark:border-gray-800 flex items-center"><button onclick="goBack()" class="mr-4"><span class="material-symbols-outlined dark:text-white">arrow_back</span></button><h1 class="text-xl font-bold dark:text-white">FCR ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞</h1></header><div class="p-6 space-y-5"><input id="fcr-bags" type="text" inputmode="numeric" placeholder="‡¶ñ‡¶æ‡¶¨‡¶æ‡¶∞‡ßá‡¶∞ ‡¶¨‡¶∏‡ßç‡¶§‡¶æ (‡ß´‡ß¶ ‡¶ï‡ßá‡¶ú‡¶ø)" class="w-full p-4 rounded-xl border bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white"><input id="fcr-extra-feed" type="text" inputmode="numeric" placeholder="‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ ‡¶ñ‡¶æ‡¶¨‡¶æ‡¶∞ (‡¶ï‡ßá‡¶ú‡¶ø)" class="w-full p-4 rounded-xl border bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white"><input id="fcr-total-weight" type="text" inputmode="numeric" placeholder="‡¶Æ‡ßã‡¶ü ‡¶Æ‡¶æ‡¶Ç‡¶∏‡ßá‡¶∞ ‡¶ì‡¶ú‡¶® (‡¶ï‡ßá‡¶ú‡¶ø)" class="w-full p-4 rounded-xl border bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white"><button onclick="calculateFCR()" class="w-full p-4 bg-purple-600 text-white font-bold rounded-xl shadow-lg">‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶ï‡¶∞‡ßÅ‡¶®</button><div id="fcr-result" class="hidden text-center pt-4 bg-gray-50 dark:bg-gray-800 rounded-xl p-4"><div class="text-4xl font-bold text-purple-600 dark:text-purple-400" id="fcr-value">0.0</div><p id="fcr-status-title" class="font-bold mt-2 dark:text-gray-300"></p><p id="fcr-total-feed-display" class="text-xs text-gray-400 mt-1"></p></div></div></div>
        <div id="due-list-page" class="page bg-gray-50 dark:bg-gray-900"><header class="p-4 bg-white dark:bg-gray-800 border-b dark:border-gray-700 flex justify-between items-center"><div class="flex items-center"><button onclick="goBack()" class="mr-4"><span class="material-symbols-outlined dark:text-white">arrow_back</span></button><h1 class="text-xl font-bold dark:text-white">‡¶¨‡¶æ‡¶ï‡¶ø‡¶∞ ‡¶ñ‡¶æ‡¶§‡¶æ</h1></div><span id="total-due-amount" class="font-bold text-teal-700 dark:text-teal-400 px-3 py-1 bg-teal-50 dark:bg-teal-900/30 rounded-full text-sm">‡ß≥0</span></header><div class="p-5 pb-28 space-y-3" id="due-list-container"></div><div class="fixed bottom-10 right-6 z-20"><button onclick="prepareDueForm()" class="w-14 h-14 rounded-full bg-teal-700 text-white shadow-xl flex items-center justify-center transform transition hover:scale-110"><span class="material-symbols-outlined text-3xl">add</span></button></div></div>
        <div id="add-due-page" class="page bg-white dark:bg-gray-900"><header class="p-4 border-b dark:border-gray-800 flex items-center"><button onclick="goBack()" class="mr-4"><span class="material-symbols-outlined dark:text-white">arrow_back</span></button><h1 id="due-form-title" class="text-xl font-bold dark:text-white">‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶æ‡¶ï‡¶ø</h1></header><div class="p-6"><form onsubmit="saveDue(event)" class="space-y-5"><input type="hidden" id="due-id"><input id="due-name" required placeholder="‡¶®‡¶æ‡¶Æ" class="w-full p-4 rounded-xl border bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white"><input id="due-mobile" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤" class="w-full p-4 rounded-xl border bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white"><input id="due-amount" type="number" required placeholder="‡¶ü‡¶æ‡¶ï‡¶æ" class="w-full p-4 rounded-xl border bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white"><input id="due-date" type="date" required class="w-full p-4 rounded-xl border bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white"><textarea id="due-note" placeholder="‡¶®‡ßã‡¶ü" class="w-full p-4 rounded-xl border bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white"></textarea><button type="submit" class="w-full p-4 bg-teal-700 text-white font-bold rounded-xl shadow-lg">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button></form></div></div>

        <div id="add-shipment-button-container" class="fixed bottom-24 right-6 z-20"><button onclick="navigate('add-shipment-page')" class="w-14 h-14 rounded-full bg-teal-700 text-white shadow-xl flex items-center justify-center transform transition hover:scale-110 active:scale-95"><span class="material-symbols-outlined text-3xl">add</span></button></div>

        <nav class="absolute bottom-0 left-0 right-0 z-10 bg-white/95 dark:bg-gray-900/95 backdrop-blur-lg border-t border-gray-200 dark:border-gray-700"><div class="flex h-16 items-center justify-around"><a href="#" onclick="navigateToTab('dashboard')" class="flex flex-col items-center gap-1 text-teal-700 dark:text-teal-400 nav-item" id="nav-dashboard"><span class="material-symbols-outlined">dashboard</span><span class="text-[10px] font-bold">‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</span></a><a href="#" onclick="navigateToTab('shipments-page')" class="flex flex-col items-center gap-1 text-gray-400 nav-item" id="nav-shipments-page"><span class="material-symbols-outlined">list_alt</span><span class="text-[10px] font-bold">‡¶ö‡¶æ‡¶≤‡¶æ‡¶®</span></a><a href="#" onclick="navigateToTab('medicines-page')" class="flex flex-col items-center gap-1 text-gray-400 nav-item" id="nav-medicines-page"><span class="material-symbols-outlined">vaccines</span><span class="text-[10px] font-bold">‡¶ì‡¶∑‡ßÅ‡¶ß</span></a><a href="#" onclick="navigateToTab('settings-page')" class="flex flex-col items-center gap-1 text-gray-400 nav-item" id="nav-settings-page"><span class="material-symbols-outlined">settings</span><span class="text-[10px] font-bold">‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</span></a></div></nav>
    </main>
    
    <div id="video-modal" class="hidden fixed inset-0 bg-black/95 z-[70] flex items-center justify-center p-4 backdrop-blur-md"><div class="bg-black w-full max-w-lg rounded-3xl overflow-hidden relative shadow-2xl border border-white/10"><button onclick="closeVideoModal()" class="absolute top-4 right-4 z-10 bg-white/10 hover:bg-red-600 text-white rounded-full p-2 backdrop-blur-md transition"><span class="material-symbols-outlined">close</span></button><div class="relative pb-[56.25%] h-0"><iframe id="youtube-frame" class="absolute top-0 left-0 w-full h-full" src="" frameborder="0" allowfullscreen></iframe></div></div></div>
    <div id="toast" class="hidden fixed bottom-20 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-5 py-2 rounded-full text-sm z-50 shadow-lg"></div>
    <div id="pdf-overlay" class="hidden"><div id="pdf-content" style="padding:30px;font-family:'Noto Sans Bengali';background:white;color:black;"><div style="text-align:center;border-bottom:2px solid #00796B;padding-bottom:10px;margin-bottom:20px;"><h1 style="font-size:24px;color:#00796B;">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</h1><p>‡¶™‡ßã‡¶≤‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶ñ‡¶æ‡¶Æ‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</p></div><table style="width:100%;margin-bottom:20px;"><tr><td><h2 id="pdf-shipment-name"></h2><p id="pdf-shipment-date"></p></td><td style="text-align:right;"><span id="pdf-chicken-count"></span></td></tr></table><div style="display:flex;margin-bottom:20px;border:1px solid #ddd;"><div style="flex:1;background:#e0f7fa;padding:10px;border-right:1px solid #ddd;">‡¶Ü‡ßü<br><b id="pdf-total-income"></b></div><div style="flex:1;background:#ffebee;padding:10px;border-right:1px solid #ddd;">‡¶¨‡ßç‡¶Ø‡ßü<br><b id="pdf-total-expense"></b></div><div style="flex:1;background:#f1f8e9;padding:10px;">‡¶≤‡¶æ‡¶≠<br><b id="pdf-net-profit"></b></div></div><table class="pdf-table" style="width:100%;border-collapse:collapse;"><thead><tr style="background:#f2f2f2;"><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th><th>‡¶ß‡¶∞‡¶®</th><th>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th></tr></thead><tbody id="pdf-table-body"></tbody></table><div style="margin-top:30px;text-align:right;font-size:10px;">Dev - Shuvo</div></div></div>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBD3Ev8Gg2yValARgfxeRlSwDWrdERmtKE",
            authDomain: "mypoltyfarm.firebaseapp.com",
            databaseURL: "https://mypoltyfarm-default-rtdb.firebaseio.com",
            projectId: "mypoltyfarm",
            storageBucket: "mypoltyfarm.firebasestorage.app",
            messagingSenderId: "620769276564",
            appId: "1:620769276564:web:939c4e1065d8dfb9d6fa81"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // 2ND FIREBASE (For Medicines)
        const medicineConfig = {
            apiKey: "AIzaSyDkqjA1Io411uidSZBLbYJlYHWGVY36zc8",
            authDomain: "shuvo-all-tools.firebaseapp.com",
            databaseURL: "https://shuvo-all-tools-default-rtdb.firebaseio.com/",
            projectId: "shuvo-all-tools",
            storageBucket: "shuvo-all-tools.appspot.com",
            messagingSenderId: "475600173705",
            appId: "1:475600173705:android:0251b1d46457dc4e806458"
        };
        const medApp = firebase.initializeApp(medicineConfig, "medApp");
        const medDb = medApp.database();

        let currentUser = null;
        let pageHistory = ['dashboard'];
        let currentShipmentId = null;
        let currentEntryType = 'expense';
        let currentEntryId = null;
        let currentShipmentData = {};

        // --- AUTH & THEME ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-page').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('current-date').innerText = new Date().toLocaleDateString('bn-BD', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                loadUserData();
            } else {
                currentUser = null;
                document.getElementById('auth-page').classList.remove('hidden');
                document.getElementById('main-app').classList.add('hidden');
            }
        });

        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        }

        // GOOGLE LOGIN
        function handleGoogleLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    showToast("‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ " + result.user.displayName);
                }).catch((error) => {
                    alert("‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + error.message);
                });
        }

        // FORGOT PASSWORD
        function handleForgotPassword() {
            const email = document.getElementById('login-email').value;
            if (!email) {
                alert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¨‡¶ï‡ßç‡¶∏‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤‡¶ü‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®, ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ ‡¶Ü‡¶¨‡¶æ‡¶∞ '‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡¶®' ‡¶è ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
                return;
            }
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    alert("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤‡ßá ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‡¶á‡¶®‡¶¨‡¶ï‡ßç‡¶∏ ‡¶¨‡¶æ ‡¶∏‡ßç‡¶™‡ßç‡¶Ø‡¶æ‡¶Æ ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
                })
                .catch((error) => {
                    alert("‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + error.message);
                });
        }

        function handleLogin() { const e=document.getElementById('login-email').value,p=document.getElementById('login-pass').value; if(e&&p)auth.signInWithEmailAndPassword(e,p).catch(err=>alert(err.message)); }
        function handleRegister() { const e=document.getElementById('reg-email').value,p=document.getElementById('reg-pass').value; if(e&&p)auth.createUserWithEmailAndPassword(e,p).catch(err=>alert(err.message)); }
        function toggleAuthMode() { document.getElementById('login-form-container').classList.toggle('hidden'); document.getElementById('register-form-container').classList.toggle('hidden'); }
        function logoutUser() { auth.signOut(); }

        // --- DATA LOADING ---
        function loadUserData() {
            if(!currentUser) return;
            const uid = currentUser.uid;
            db.ref(`users/${uid}/shipments`).on('value', s => renderShipments(s.val()));
            db.ref(`users/${uid}/due_list`).on('value', s => renderDue(s.val()));
            medDb.ref('admin_scroll_text').on('value', s => document.getElementById('scrollText').innerText = s.val() || "‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶®‡ßá‡¶á");
            
            const dayStyles = [{ bg: "bg-amber-50 dark:bg-amber-900/10", border: "border-amber-200 dark:border-amber-800", text: "text-amber-700 dark:text-amber-400" }, 
                               { bg: "bg-emerald-50 dark:bg-emerald-900/10", border: "border-emerald-200 dark:border-emerald-800", text: "text-emerald-700 dark:text-emerald-400" }, 
                               { bg: "bg-sky-50 dark:bg-sky-900/10", border: "border-sky-200 dark:border-sky-800", text: "text-sky-700 dark:text-sky-400" }, 
                               { bg: "bg-rose-50 dark:bg-rose-900/10", border: "border-rose-200 dark:border-rose-800", text: "text-rose-700 dark:text-rose-400" }];
            medDb.ref('admin_medicines').on('value', s => {
                const c = document.getElementById("medicineListContainer"); c.innerHTML="";
                const data = s.val();
                if(!data) { c.innerHTML=`<div class="text-center py-20 opacity-50"><span class="material-symbols-outlined text-6xl mb-2">inventory_2</span><p>‡¶§‡¶•‡ßç‡¶Ø ‡¶®‡ßá‡¶á</p></div>`; return; }
                const grouped = {};
                Object.values(data).forEach(item => { item.day.split("‚Üí").map(d=>d.trim()).forEach(d => { if(!grouped[d]) grouped[d]=[]; grouped[d].push(item); }); });
                Object.keys(grouped).sort((a,b)=>parseInt(a)-parseInt(b)).forEach((day, idx) => {
                    const style = dayStyles[idx % dayStyles.length];
                    const sec = document.createElement("div"); sec.className = "space-y-3";
                    sec.innerHTML = `<div class="flex items-center gap-3 mb-4"><span class="bg-teal-700 text-white px-3 py-1 rounded-full text-xs font-bold">‡¶¶‡¶ø‡¶® ${day}</span><div class="h-[1px] bg-gray-200 dark:bg-gray-700 flex-grow"></div></div>`;
                    grouped[day].sort((a,b)=>a.serial-b.serial).forEach(item => {
                        sec.innerHTML += `<div class="p-5 border ${style.border} ${style.bg} rounded-3xl transition-all hover:shadow-md"><div class="flex justify-between items-start mb-2"><h4 class="font-bold text-lg flex items-center gap-2 dark:text-gray-100"><span class="material-symbols-outlined text-teal-700 dark:text-teal-400">medication</span>${item.medicine}</h4><span class="text-[10px] font-bold uppercase ${style.text} bg-white dark:bg-black/30 px-2 py-1 rounded-lg">${item.time}</span></div><div class="flex items-center gap-2 text-sm opacity-80 mb-2 dark:text-gray-300"><span class="material-symbols-outlined text-sm">scale</span>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£: ${item.amount}</div>${item.note ? `<div class="mt-3 pt-3 border-t border-black/5 dark:border-white/5 flex gap-2"><span class="material-symbols-outlined text-sm text-red-500">info</span><p class="text-xs text-red-600 dark:text-red-400 font-medium"><b>‡¶¨‡¶ø:‡¶¶‡ßç‡¶∞:</b> ${item.note}</p></div>` : ""}</div>`;
                    });
                    c.appendChild(sec);
                });
            });
        }

        // --- NAVIGATION ---
        function navigate(p) { document.querySelectorAll('.page').forEach(e=>e.classList.remove('page-visible')); document.getElementById(p).classList.add('page-visible'); pageHistory.push(p); document.getElementById('add-shipment-button-container').classList.toggle('hidden', !['dashboard','shipments-page'].includes(p)); }
        function goBack() { if(pageHistory.length>1) pageHistory.pop(); navigate(pageHistory[pageHistory.length-1]); pageHistory.pop(); }
        function navigateToTab(p) { pageHistory=[p]; navigate(p); document.querySelectorAll('.nav-item').forEach(e=>{ e.classList.remove('text-teal-700', 'dark:text-teal-400'); if(e.id===`nav-${p}`) e.classList.add('text-teal-700', 'dark:text-teal-400'); }); }
        function switchTab(t) { currentEntryType=t; document.getElementById('expense-list-container').classList.toggle('hidden', t!=='expense'); document.getElementById('income-list-container').classList.toggle('hidden', t!=='income'); document.getElementById('expense-tab-button').className=`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${t==='expense'?'bg-white dark:bg-gray-600 shadow text-teal-700 dark:text-white':'text-gray-500 dark:text-gray-400'}`; document.getElementById('income-tab-button').className=`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${t==='income'?'bg-white dark:bg-gray-600 shadow text-teal-700 dark:text-white':'text-gray-500 dark:text-gray-400'}`; }
        function toggleMenu(id) { document.getElementById(id).classList.toggle('hidden'); }
        document.onclick = (e) => { if(!e.target.closest('.relative')) document.querySelectorAll('#dropdownMenu, [id^="opt-"]').forEach(el=>el.classList.add('hidden')); };
        
        // --- CRUD ---
        function saveShipment(e) { e.preventDefault(); if(!currentUser) return alert("‡¶≤‡¶ó‡¶á‡¶® ‡¶®‡ßá‡¶á"); const d={name:document.getElementById('shipment-name').value, chickenCount:document.getElementById('shipment-chicken-count').value, startDate:document.getElementById('shipment-start-date').value}; db.ref(`users/${currentUser.uid}/shipments`).push(d).then(()=>{showToast("‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá"); goBack();}); }
        function saveEntry(e) { e.preventDefault(); if(!currentUser) return; const d={amount:document.getElementById('entry-amount').value, date:document.getElementById('entry-date').value, note:document.getElementById('entry-note').value}; if(currentEntryType==='expense') d.type=document.getElementById('expense-type').value; else d.description=document.getElementById('income-description').value; const p=`users/${currentUser.uid}/shipments/${currentShipmentId}/${currentEntryType}s`; (currentEntryId?db.ref(`${p}/${currentEntryId}`).update(d):db.ref(p).push(d)).then(()=>{showToast("‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá"); goBack();}); }
        function saveDue(e) { e.preventDefault(); const id=document.getElementById('due-id').value; const d={name:document.getElementById('due-name').value, mobile:document.getElementById('due-mobile').value, amount:document.getElementById('due-amount').value, date:document.getElementById('due-date').value, note:document.getElementById('due-note').value}; (id?db.ref(`users/${currentUser.uid}/due_list/${id}`).update(d):db.ref(`users/${currentUser.uid}/due_list`).push(d)).then(()=>{showToast("‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá"); goBack();}); }
        function prepareEntryForm() { document.forms[1].reset(); currentEntryId=null; document.getElementById('entry-date').valueAsDate=new Date(); document.getElementById('entry-form-title').innerText=currentEntryType==='expense'?'‡¶®‡¶§‡ßÅ‡¶® ‡¶ñ‡¶∞‡¶ö':'‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡ßü'; document.getElementById('expense-fields').classList.toggle('hidden', currentEntryType!=='expense'); document.getElementById('income-fields').classList.toggle('hidden', currentEntryType!=='income'); navigate('add-entry-page'); }
        function prepareDueForm() { document.forms[2].reset(); document.getElementById('due-id').value=''; document.getElementById('due-date').valueAsDate=new Date(); navigate('add-due-page'); }
        function editEntry(t,i) { db.ref(`users/${currentUser.uid}/shipments/${currentShipmentId}/${t}s/${i}`).once('value',s=>{ const d=s.val(); currentEntryId=i; document.getElementById('entry-amount').value=d.amount; document.getElementById('entry-date').value=d.date; document.getElementById('entry-note').value=d.note||''; if(t==='expense'){document.getElementById('expense-type').value=d.type;document.getElementById('expense-fields').classList.remove('hidden');document.getElementById('income-fields').classList.add('hidden');}else{document.getElementById('income-description').value=d.description;document.getElementById('expense-fields').classList.add('hidden');document.getElementById('income-fields').classList.remove('hidden');} navigate('add-entry-page'); }); }
        function editDue(i) { db.ref(`users/${currentUser.uid}/due_list/${i}`).once('value',s=>{ const d=s.val(); document.getElementById('due-id').value=i; document.getElementById('due-name').value=d.name; document.getElementById('due-mobile').value=d.mobile; document.getElementById('due-amount').value=d.amount; document.getElementById('due-date').value=d.date; document.getElementById('due-note').value=d.note||''; navigate('add-due-page'); }); }
        function deleteCurrentShipment() { if(confirm("‡¶Æ‡ßÅ‡¶õ‡¶¨‡ßá‡¶®?")) db.ref(`users/${currentUser.uid}/shipments/${currentShipmentId}`).remove().then(()=>navigate('dashboard')); }
        function deleteEntry(t,i) { if(confirm("‡¶Æ‡ßÅ‡¶õ‡¶¨‡ßá‡¶®?")) db.ref(`users/${currentUser.uid}/shipments/${currentShipmentId}/${t}s/${i}`).remove(); }
        function deleteDue(i) { if(confirm("‡¶Æ‡ßÅ‡¶õ‡¶¨‡ßá‡¶®?")) db.ref(`users/${currentUser.uid}/due_list/${i}`).remove(); }
        function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),2000); }
        
        function renderShipments(data) { const list=document.getElementById('ongoing-shipments-list'), all=document.getElementById('all-shipments-list'); list.innerHTML=all.innerHTML=''; if(!data){ list.innerHTML="<p class='text-center text-gray-400 py-10 dark:text-gray-500'>‡¶ï‡ßã‡¶®‡ßã ‡¶ö‡¶æ‡¶≤‡¶æ‡¶® ‡¶®‡ßá‡¶á</p>"; return; } let total=0; Object.keys(data).reverse().forEach(k => { total++; const h=`<div onclick="viewShipment('${k}')" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm flex items-center gap-4 border border-gray-100 dark:border-gray-700 hover:shadow-md transition cursor-pointer"><div class="w-12 h-12 bg-teal-50 dark:bg-teal-900/30 rounded-full flex items-center justify-center text-2xl">üêî</div><div><h3 class="font-bold text-gray-800 dark:text-gray-100">${data[k].name}</h3><p class="text-xs text-gray-500 dark:text-gray-400">${data[k].startDate}</p></div></div>`; all.innerHTML+=h; if(list.children.length<3) list.innerHTML+=h; }); document.getElementById('dashboard-summary').innerHTML=`<div class="bg-gradient-to-r from-teal-600 to-teal-500 rounded-2xl p-6 text-white shadow-lg shadow-teal-200 dark:shadow-none"><p class="text-teal-100 text-sm font-medium">‡¶Æ‡ßã‡¶ü ‡¶ö‡¶æ‡¶≤‡¶æ‡¶®</p><h2 class="text-4xl font-bold mt-1">${total}</h2></div>`; }
        function renderDue(data) { const el=document.getElementById('due-list-container'); el.innerHTML=''; let t=0; if(data) Object.entries(data).reverse().forEach(([k,v])=>{ t+= +v.amount; el.innerHTML+=`<div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm flex justify-between items-start border border-gray-50 dark:border-gray-700"><div class="flex-grow"><h3 class="font-bold text-gray-800 dark:text-gray-100">${v.name}</h3><p class="text-xs text-gray-500 dark:text-gray-400">${v.mobile||''}</p><p class="text-xs text-gray-400 mt-1">${v.date}</p></div><div class="text-right"><p class="font-bold text-red-500 text-lg">‡ß≥${v.amount}</p><div class="relative mt-2"><button onclick="event.stopPropagation(); toggleMenu('due-opt-${k}')" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><span class="material-symbols-outlined text-gray-400">more_vert</span></button><div id="due-opt-${k}" class="hidden absolute right-0 mt-1 w-32 bg-white dark:bg-gray-700 shadow-xl rounded-xl z-10 border dark:border-gray-600 overflow-hidden"><button onclick="editDue('${k}')" class="w-full text-left px-4 py-3 text-sm hover:bg-gray-50 dark:hover:bg-gray-600 dark:text-white">‡¶è‡¶°‡¶ø‡¶ü</button><button onclick="deleteDue('${k}')" class="w-full text-left px-4 py-3 text-sm text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20">‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button></div></div></div></div>`; }); document.getElementById('total-due-amount').innerText = `‡ß≥${t.toLocaleString('bn-BD')}`; }
        function viewShipment(id) { currentShipmentId = id; navigate('shipment-details-page'); db.ref(`users/${currentUser.uid}/shipments/${id}`).on('value', s => { if(!s.exists()) { goBack(); return; } const d = s.val(); currentShipmentData = d; document.getElementById('details-shipment-name').innerText = d.name; const exp = Object.values(d.expenses||{}), inc = Object.values(d.incomes||{}); const te = exp.reduce((a,b)=>a+(+b.amount),0), ti = inc.reduce((a,b)=>a+(+b.amount),0), p = ti-te; document.getElementById('details-summary-cards').innerHTML = `<div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700"><p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-bold tracking-wider">‡¶≤‡¶æ‡¶≠ / ‡¶≤‡¶∏</p><p class="text-2xl font-bold mt-1 ${p>=0?'text-green-600':'text-red-500'}">‡ß≥${p.toLocaleString()}</p></div><div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700"><p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-bold tracking-wider">‡¶Æ‡ßã‡¶ü ‡¶Ü‡ßü</p><p class="text-2xl font-bold mt-1 text-teal-600 dark:text-teal-400">‡ß≥${ti.toLocaleString()}</p></div><div class="col-span-2 bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex justify-between items-center"><div><p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-bold tracking-wider">‡¶Æ‡ßã‡¶ü ‡¶¨‡ßç‡¶Ø‡ßü</p><p class="text-2xl font-bold mt-1 text-red-500">‡ß≥${te.toLocaleString()}</p></div></div>`; const row = (list, t) => Object.entries(list||{}).reverse().map(([k,v])=>`<div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm flex justify-between items-start border border-gray-50 dark:border-gray-700"><div><h4 class="font-bold text-gray-800 dark:text-gray-200">${t==='expense'?v.type:v.description}</h4><p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${v.date}</p>${v.note?`<p class="text-xs text-gray-400 mt-1 bg-gray-50 dark:bg-gray-700 inline-block px-2 py-1 rounded">üìù ${v.note}</p>`:''}</div><div class="text-right"><p class="font-bold text-gray-800 dark:text-gray-200">‡ß≥${v.amount}</p><div class="relative mt-2"><button onclick="event.stopPropagation(); toggleMenu('opt-${k}')" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><span class="material-symbols-outlined text-gray-400">more_vert</span></button><div id="opt-${k}" class="hidden absolute right-0 mt-1 w-32 bg-white dark:bg-gray-700 shadow-xl rounded-xl z-10 border dark:border-gray-600 overflow-hidden"><button onclick="editEntry('${t}','${k}')" class="w-full text-left px-4 py-3 text-sm hover:bg-gray-50 dark:hover:bg-gray-600 dark:text-white">‡¶è‡¶°‡¶ø‡¶ü</button><button onclick="deleteEntry('${t}','${k}')" class="w-full text-left px-4 py-3 text-sm text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20">‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button></div></div></div></div>`).join(''); document.getElementById('expense-list-container').innerHTML = row(d.expenses,'expense') || '<div class="text-center py-10 text-gray-400 dark:text-gray-500">‡¶ñ‡¶∞‡¶ö ‡¶®‡ßá‡¶á</div>'; document.getElementById('income-list-container').innerHTML = row(d.incomes,'income') || '<div class="text-center py-10 text-gray-400 dark:text-gray-500">‡¶Ü‡ßü ‡¶®‡ßá‡¶á</div>'; }); }

        function openCategoryReport() {
            if (!currentShipmentData.expenses) { alert("‡¶ï‡ßã‡¶®‡ßã ‡¶ñ‡¶∞‡¶ö ‡¶®‡ßá‡¶á!"); return; }
            const expenses = Object.values(currentShipmentData.expenses);
            const grouped = {}; let total = 0;
            expenses.forEach(e => { if (!grouped[e.type]) grouped[e.type] = { amount: 0, items: [] }; grouped[e.type].amount += +e.amount; grouped[e.type].items.push(e); total += +e.amount; });
            const content = document.getElementById('category-report-content'); content.innerHTML = '';
            Object.entries(grouped).forEach(([type, data]) => {
                const percent = ((data.amount / total) * 100).toFixed(0);
                content.innerHTML += `<details class="bg-gray-50 dark:bg-gray-700 rounded-xl overflow-hidden group border border-gray-100 dark:border-gray-600"><summary class="flex justify-between items-center p-4 hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer select-none"><div><span class="font-bold text-gray-800 dark:text-gray-200">${type}</span><div class="w-24 bg-gray-200 dark:bg-gray-500 rounded-full h-1.5 mt-1"><div class="bg-teal-600 dark:bg-teal-400 h-1.5 rounded-full" style="width: ${percent}%"></div></div></div><span class="font-bold text-teal-700 dark:text-teal-400">‡ß≥${data.amount}</span></summary><div class="bg-white dark:bg-gray-800 p-4 border-t border-gray-100 dark:border-gray-600 text-sm space-y-2">${data.items.map(i => `<div class="flex justify-between text-gray-500 dark:text-gray-400"><span>${i.date}</span><span>‡ß≥${i.amount}</span></div>`).join('')}</div></details>`;
            });
            document.getElementById('category-modal').classList.remove('hidden');
        }

        // --- NEW FCR LOGIC ---
        function calculateFCR() {
            const toEn = n => n.replace(/[‡ß¶-‡ßØ]/g, d => "‡ß¶‡ßß‡ß®‡ß©‡ß™‡ß´‡ß¨‡ß≠‡ßÆ‡ßØ".indexOf(d));
            const b = parseFloat(toEn(document.getElementById('fcr-bags').value)) || 0;
            const e = parseFloat(toEn(document.getElementById('fcr-extra-feed').value)) || 0;
            const w = parseFloat(toEn(document.getElementById('fcr-total-weight').value)) || 0;
            if(w > 0){
                const totalFeed = (b * 50) + e;
                const f = totalFeed / w;
                document.getElementById('fcr-result').classList.remove('hidden');
                document.getElementById('fcr-value').innerText = f.toFixed(2);
                document.getElementById('fcr-total-feed-display').innerText = `‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶æ‡¶¨‡¶æ‡¶∞: ${totalFeed} ‡¶ï‡ßá‡¶ú‡¶ø`;
                
                // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶®‡¶§‡ßÅ‡¶® ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ
                let msg = "";
                if (f <= 1.49) {
                    msg = "‡¶Ö‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ (Excellent) ü§©";
                } else if (f >= 1.50 && f <= 1.69) {
                    msg = "‡¶≠‡¶æ‡¶≤‡ßã/‡¶∏‡ßç‡¶¨‡¶æ‡¶≠‡¶æ‡¶¨‡¶ø‡¶ï (Good) üôÇ";
                } else if (f >= 1.70 && f <= 1.89) {
                    msg = "‡¶ó‡ßú‡¶™‡ßú‡¶§‡¶æ (Average) üòê";
                } else {
                    msg = "‡¶Æ‡¶®‡ßç‡¶¶/‡¶≤‡ßã‡¶ï‡¶∏‡¶æ‡¶® (Poor) üòü";
                }

                document.getElementById('fcr-status-title').innerText = msg;
            } else { alert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶ì‡¶ú‡¶® ‡¶¶‡¶ø‡¶®"); }
        }

        function sharePDF() { db.ref(`users/${currentUser.uid}/shipments/${currentShipmentId}`).once('value',s=>{ const d=s.val(); document.getElementById('pdf-shipment-name').innerText=d.name; document.getElementById('pdf-shipment-date').innerText=d.startDate; document.getElementById('pdf-chicken-count').innerText="‡¶Æ‡ßÅ‡¶∞‡¶ó‡¶ø: "+d.chickenCount; let ti=0,te=0,h=''; const all=[...Object.values(d.expenses||{}).map(x=>({...x,t:'‡¶¨‡ßç‡¶Ø‡ßü'})),...Object.values(d.incomes||{}).map(x=>({...x,t:'‡¶Ü‡ßü'}))].sort((a,b)=>new Date(a.date)-new Date(b.date)); all.forEach(x=>{ if(x.t==='‡¶¨‡ßç‡¶Ø‡ßü')te+=+x.amount;else ti+=+x.amount; h+=`<tr><td>${x.date}</td><td>${x.type||x.description}</td><td>${x.t}</td><td style="text-align:right">${x.amount}</td></tr>`; }); document.getElementById('pdf-total-income').innerText="‡ß≥"+ti; document.getElementById('pdf-total-expense').innerText="‡ß≥"+te; document.getElementById('pdf-net-profit').innerText="‡ß≥"+(ti-te); document.getElementById('pdf-table-body').innerHTML=h; document.getElementById('pdf-overlay').style.display='block'; html2pdf().from(document.getElementById('pdf-content')).save().then(()=>document.getElementById('pdf-overlay').style.display='none'); }); }
        function openVideoModal() { document.getElementById('video-modal').classList.remove('hidden'); document.getElementById('youtube-frame').src="https://drive.google.com/file/d/1ErsItnwlAp3miAbUdC-KTNR3OnHQmm5l/preview"; }
        function closeVideoModal() { document.getElementById('video-modal').classList.add('hidden'); document.getElementById('youtube-frame').src=""; }

        // Start
        navigateToTab('dashboard');
    </script>
</body>
</html>
